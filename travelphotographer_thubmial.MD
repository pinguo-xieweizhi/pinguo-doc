# 旅拍大图制作缩略图方案

## 客户端方案1
   即客户端在上传原图时，对原图进行缩略图的制作，并将缩略图和原图一起上传到七牛服务器。且在服务端会保存缩略图完整信息，方便后续二销相册以及各端使用。
### 方案阐述

     1. 客户端调用服务端始化上传接口,上传原图和缩略图信息，服务端返回上传凭证（此凭证应用前缀匹配，支持传多张，且缩略图的最大尺寸不能大于原图）
     2. 客户端根据上传凭证上传原图和缩略图
     3. 客户端上传成功后调用服务端接口，通知上传完成
   
### 涉及修改

#### 客户端：

    1. 需要对图片进行压缩，生成缩略图
    2. 初始化上传接口需要上报缩略图和原图信息
   
#### 服务端：

    1. 修改初始化上传接口，接收缩略图和原图信息
    2. 图片存储接口需要新增字段，存储缩略图信息
    3. 中央厨房精修后的图也需要生成缩略图，修图完成相关消息需要增加字段接收缩略图信息
   
## 客户端方案2
    即客户端在上传原图时，对原图进行等比缩略图的制作，并将缩略图和原图一起上传到七牛服务器。服务端只保存原图信息，缩略图信息在下发图片数据时由服务端根据需求动态组装，且返回原图的宽高信息（ps：此方案已与客户端确认, 客户端之所以需要宽高信息是因为需要计算宽高比）
### 方案阐述
    
    1. 客户端调用初始化上传接口，只上报原图信息，服务端根据原图大小判断是否需要生成缩略图，如需要则会额外下发缩略图上传key
    2. 客户端根据返回值决定是否需要根据原图生成缩略图；
    3. 客户端上传原图和缩略图到七牛；
    4. 确认都上传完成后通知上传完成；
    5. 服务端下发图片数据时，根据需求，动态组装缩略图数据返回；

### 涉及修改

    1. 客户端：
        1. 根据原图生成缩略图
        2. 上传原图和缩略图，并在都上传成功后通知上传完成
    2. 服务端：
        1. 修改初始化上传接口，判断是否需要生成缩略图，并在返回信息中增加缩略图上传key
        2. 修改图片存储接口，存储原图信息
        3. 修改下发图片数据接口，根据客户端需求，动态组装缩略图数据返回
         

## 服务端方案
    由服务端根据客户端上传接口提供的信息判断生成上传凭证时是否需要在token中增加生成缩略图的命令，并在token中设置异步通知回调地址接收七牛作图回调，并将缩略图信息进行保存。
### 方案阐述
    1. 服务端在生成上传token时，根据原图信息判断是否需要生成缩略图，如需要则在token中增加生成缩略图的命令和异步通知回调地址，和携带自定义参数方便通知回调时设置对应参数
    2. 七牛服务器在生成缩略图后，根据回调地址通知服务端
    3. 服务端根据七牛服务器通知信息，更新缩略图信息
    4. 服务端下发图片数据时，根据缩略图信息是否存在下发缩略图或者原图

## 方案对比

| 方案 | 优点 | 缺点 | 服务端改动 | 客户端改动 |
| --- | --- | --- | --- | --- |
| 客户端方案1 | 能确保缩略图数据完整 | 客服端与服务端改动较大 | 改动大 | 改动大 |
| 客户端方案2 | 客服端和服务端改动较小 | 缩略图数据依赖规则拼接 | 改动小 | 改动大 |
| 服务端方案 | 缩略图数据完整，客服端改动较小，缩略图的生成完全依赖七牛，在不使用专用队列时速度比较慢，且无法保证缩略图一定能生成成功 | 服务端改动较大 | 改动大 | 改动小 |
