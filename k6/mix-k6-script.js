// Auto-generated by the postman-to-k6 converter

import "./libs/shim/core.js";
import "./libs/shim/crypto-js.js";
import "./libs/shim/urijs.js";
import { group } from "k6";

export let options = { maxRedirects: 4 };

const Pre = Symbol.for("pre");
const Request = Symbol.for("request");
postman[Symbol.for("initial")]({
  options,
  collection: {
    "host-dev": "http://mix-api-dev.camera360.com",
    "host-ubuntudev": "ubuntu-dev:8010",
    "host-qa": "https://mix-api-qa.camera360.com",
    "host-prod": "https://mix-api.camera360.com",
    "host-prod-en": "https://mix-api.360in.com",
    "PG-AppID": "MIX",
    "PG-Platform": "Android",
    "PG-UserID": "60fa46abd23b5750de6a4005",
    "PG-UserToken":
      "d2M0UkVXWk1MRE5jTk5XTXBEK1ZaTm9EYnlEQ2xGb1NhOXVIQ0psaEUzdDFVOFFIUUlGQUdVNk9jTWNxQ0hOTkNJSnBTbEF0YTl4NVRSLzJlQk13K0d3WitENDFobGdPbzd1Y2pUOEpVdUVOMzFTL0ZyclhiNUh3L1ZMdzM4YUt3VTg0Z2FzZzJ4a2oxSTB5RjZNQzdBdUcyaHREeXBFRA==",
    "PG-AppVersion": "9.9.91",
    "PG-OSVersion": "13",
    "PG-Model": "iPhone13",
    "PG-EID": "6E72823C-953A-4C77-A821-822610AAF468",
    "PG-FA": "",
    "PG-FV": "",
    "PG-LL": "",
    "PG-Channel": "AppleStore",
    "PG-InitStamp": "1635400194",
    "PG-UpgradeStamp": "1635400194",
    "PG-ScreenSize": "720*1280",
    "PG-Language": "zh-Hans",
    "PG-UtcOffset": "28800",
    "PG-Network": "5G",
    "PG-ENCH": "0",
    "PG-ENCB": "0",
    "PG-Debug": "1",
    "PG-Locale": "zh_CN",
    "PG-Sign": "56610f9fce1cdd07098cd81d",
    "sign-secret-prod": "59BC341729EDE401AFB65C3C7ACFCGC3",
    "PG-DataEnv": "operation",
    "sign-secret-qa": "49BC34102930E4AAAFA78C3C7ACGCNV9"
  }
});

export default function () {
  postman[Pre].push(() => {
    var env = pm.environment.get("env");
    pm.environment.get("variable_key");
    pm.globals.get("variable_key");
    pm.variables.get("variable_key");
    pm.collectionVariables.get("variable_key");
    // if (env) {
    //     var host = pm.variables.get("host-" + env);
    //     if (host) {
    //         pm.variables.set("host", host);
    //     }
    // }

    function isRequestHeaderValid(key) {
      console.log("lg---key:", key)
      let v = pm.request.headers.one(key);
      return v && !v.disabled;
    }

    const HostConfigs = {
      data: {
        __default: "localhost:8000",
        MIX_qa: "https://mix-api-qa.camera360.com",
        MIX_dev: "https://mix-api-dev.camera360.com",
        MIX_prod: "https://mix-api.camera360.com",
        "MIX_prod-en": "https://mix-api.360in.com"
      },

      inject: function () {
        const AppID = isRequestHeaderValid("PG-AppID")
          ? pm.request.headers.get("PG-AppID")
          : pm.variables.get("PG-AppID");
        let key = `${AppID}_${env}`;
        pm.variables.set("host", this.data[key] || this.data.__default);
      }
    };

    HostConfigs.inject();

    const SecretConfigs = {
      data: {
        __default: "56610f9fce1cdd07098cd81d",

        MIX_Android_prod: "99BC34102930E4AAAFA78C3C7ACGCNV8",
        MIX_Android_qa: "49BC34102930E4AAAFA78C3C7ACGCNV9",
        MIX_iOS_prod: "99BC341029EDE401AFB78C3C7ACFCNV8",
        MIX_iOS_qa: "49BC341029EDE401AFB78C3C7ACFCNV9"
      },

      get: function () {
        const appID = this.__getFromHeaderFirst("PG-AppID");
        const platform = this.__getFromHeaderFirst("PG-Platform");
        let cEnv = env;
        if (cEnv.indexOf("prod") >= 0) {
          cEnv = "prod";
        }
        let confKey = `${appID}_${platform}_${cEnv}`;
        if (this.data[confKey]) {
          return this.data[confKey];
        }
        return this.data.__default;
      },

      __getFromHeaderFirst: function (key) {
        if (isRequestHeaderValid(key)) {
          return pm.request.headers.get(key);
        }
        return pm.variables.get(key);
      }
    };

    // 请求公共参数及请求签名
    const SignSecret = SecretConfigs.get();
    if (SignSecret && pm.collectionVariables.get("PG-AppID")) {
      //const now = ((new Date).getTime() / 1000).toFixed(0);
      const now = "1661944317";
      const variables = pm.collectionVariables.toObject();
      // build header params
      var signArray = [];
      for (let key in variables) {
        if (key.indexOf("PG") !== 0) {
          continue;
        }
        variables[key] = variables[key].trim();
      }
      for (let key in variables) {
        if (key.indexOf("PG") !== 0) {
          continue;
        }

        switch (key) {
          case "PG-Sign":
          case "PG-Time":
            break;
          default:
            let value = variables[key];
            if (isRequestHeaderValid(key)) {
              value = pm.request.headers.get(key);
            }
            signArray.push(key + "=" + value);
            pm.request.headers.upsert({
              key: key,
              value: value,
              disabled: false
            });
        }
      }
      signArray.push("PG-Time=" + now);
      pm.request.headers.upsert({ key: "PG-Time", value: now });

      if (isRequestHeaderValid("PG-Sign")) {
        // fallthrough
      } else if (pm.variables.get("PG-Sign")) {
        // 使用配置的签名
        // console.info("default sign secret used, secret:", pm.variables.get("PG-Sign"))
        pm.request.headers.upsert({
          key: "PG-Sign",
          value: pm.variables.get("PG-Sign")
        });
      } else {
        // build query params
        pm.request.url.query.map(v => {
          if (!v.disabled) {
            signArray.push(v.key + "=" + v.value);
          }
        });

        signArray.sort();

        let signStr =
          requestPath() +
          pm.request.method +
          signArray.join("") +
          md5JSONBody();
        console.log(signStr);
        console.info(SignSecret);
        const sign = CryptoJS.HmacSHA256(signStr, SignSecret).toString();
        console.info("calculate sign, secret:", SignSecret);
        console.info(sign);
        pm.request.headers.upsert({ key: "PG-Sign", value: sign });
      }

      var pHeaders = "";
      pm.request.headers.each(v => {
        if (v.key.indexOf("PG-") === 0) {
          pHeaders += ` -H "${v.key}: ${v.value}"`;
        }
      });
      console.info(`curl ${pHeaders} ${pm.request.url.toString()}`);
    }

    /**
     * get request path
     */
    function requestPath() {
      var parts = [];
      pm.request.url.path.map(v => {
        if (v.indexOf(":") === 0) {
          const find = pm.request.url.variables.find(
            item => item.key == v.slice(1)
          );
          parts.push(find.value);
        } else {
          parts.push(v);
        }
      });

      if (parts.length > 0) {
        return "/" + parts.join("/");
      }
      return "";
    }

    function md5JSONBody() {
      const body = pm.request.body;

      if (
        body &&
        body.raw &&
        body.mode === "raw" &&
        body.options &&
        body.options.raw &&
        body.options.raw.language &&
        body.options.raw.language === "json"
      ) {
        return CryptoJS.MD5(body.raw).toString();
      }

      return "";
    }
  });

  group("v1", function () {
    group("product", function () {
      postman[Request]({
        name: "上报商品购买信息",
        id: "0427e691-24e9-4ddf-9ad5-cf51cc2cc602",
        method: "POST",
        address: "{{host}}/v1/product-purchase/report",
        headers: {
          "PG-AppID": "MIX",
          "PG-Platform": "Android",
          "PG-UserID": "60fa46abd23b5750de6a4005",
          "PG-UserToken":
            "d2M0UkVXWk1MRE5jTk5XTXBEK1ZaTm9EYnlEQ2xGb1NhOXVIQ0psaEUzdDFVOFFIUUlGQUdVNk9jTWNxQ0hOTkNJSnBTbEF0YTl4NVRSLzJlQk13K0d3WitENDFobGdPbzd1Y2pUOEpVdUVOMzFTL0ZyclhiNUh3L1ZMdzM4YUt3VTg0Z2FzZzJ4a2oxSTB5RjZNQzdBdUcyaHREeXBFRA==",
          "PG-AppVersion": "9.9.91",
          "PG-OSVersion": "13",
          "PG-Model": "iPhone13",
          "PG-EID": "6E72823C-953A-4C77-A821-822610AAF468",
          "PG-FA": "",
          "PG-FV": "",
          "PG-LL": "",
          "PG-Channel": "AppleStore",
          "PG-InitStamp": "1635400194",
          "PG-UpgradeStamp": "1635400194",
          "PG-ScreenSize": "720*1280",
          "PG-Language": "zh-Hans",
          "PG-UtcOffset": "28800",
          "PG-Network": "5G",
          "PG-ENCH": "0",
          "PG-ENCB": "0",
          "PG-Debug": "1",
          "PG-Locale": "zh_CN",
          // "PG-Sign": "56610f9fce1cdd07098cd81d",
          "sign-secret-prod": "59BC341729EDE401AFB65C3C7ACFCGC3",
          "PG-DataEnv": "operation",
          "sign-secret-qa": "49BC34102930E4AAAFA78C3C7ACGCNV9",
        },
        data:
          '{\n    "productId":"1111-test",\n    "userId":"userid-test1",\n    "deviceId":"deviceid-test1",\n    "purchaseCount": 1,\n    "purchaseAt": 1712137354\n}'
      });

  //     postman[Request]({
  //       name: "购买检查",
  //       id: "72b4013a-828a-4b42-96ba-60a59ec3dbc9",
  //       method: "POST",
  //       address: "{{host}}/v1/product-positions/purchase/validate",
  //       data:
  //         '{\n    "items": [\n        {\n            "productId": "661235ef1448c649004bafb7",\n            "placeInfoExtra": "promotion-t2|661236a31448c649004bafbc|661237871448c649004bafbf|661235ef1448c649004bafb7|661235ef1448c649004bafb8|661236a31448c649004bafbb|661237871448c649004bafbe",\n            "purchaseCount": 3\n        }\n    ]\n}'
  //     });

  //     postman[Request]({
  //       name: "商品投放信息 Copy",
  //       id: "29563a82-e0c8-41e8-ae33-e0f21de9330b",
  //       method: "GET",
  //       address: "{{host}}/v1/product-positions/vipProduct/products",
  //       headers: {
  //         "PG-DataEnv": "prod",
  //         "X-Custom-IP": "182.150.56.79prod",
  //         "PG-Platform": "iOS",
  //         "PG-Language": "zh-hans"
  //       }
  //     });

  //     postman[Request]({
  //       name: "商品投放信息 Copy 2",
  //       id: "e21c72ed-6100-427e-9f27-dd1bb5b4b5a0",
  //       method: "GET",
  //       address:
  //         "{{host}}/v1/product-positions//product/detail?ids=65b72063a09649163ea20c98",
  //       headers: {
  //         "PG-DataEnv": "qa",
  //         "X-Custom-IP": "182.150.56.79",
  //         "PG-Platform": "iOS",
  //         "PG-Language": "zh-hans"
  //       }
  //     });
  //   });

  //   postman[Request]({
  //     name: "PullByCodes",
  //     id: "9d3631ee-aabf-451c-843b-6879d6720ad6",
  //     method: "GET",
  //     address: "{{host}}/v1/operational-positions?codes=BannerHomepage",
  //     headers: {
  //       "Pg-Platform": "Ios"
  //     }
  //   });

  //   postman[Request]({
  //     name: "PullByCode-ok",
  //     id: "9fe32c37-b79a-4b3e-926c-aa3512100614",
  //     method: "GET",
  //     address:
  //       "{{host}}/v2/material-positions/androidFont/materials?vipStatus=original"
  //   });

  //   postman[Request]({
  //     name: "PullByCodes - MIX Android",
  //     id: "64dd842d-790d-4b74-8eb6-a5cc311d6f4a",
  //     method: "GET",
  //     address: "{{host}}/v1/operational-positions?codes=BtnHomepage",
  //     headers: {
  //       "PG-AppID": "MIX",
  //       "PG-Platform": "iOS",
  //       "PG-AppVersion": "5.9.60"
  //     }
  //   });

  //   postman[Request]({
  //     name: "PullByCodes - MIX Android Copy",
  //     id: "dd12e6af-0d80-45a9-af1d-f53250b69cf4",
  //     method: "GET",
  //     address:
  //       "{{host}}/v1/operational-positions?vipStatus=original&codes=BannerHomepage-A",
  //     headers: {
  //       "PG-AppID": "MIX",
  //       "PG-Platform": "Android",
  //       "PG-AppVersion": "4.9.60"
  //     }
  //   });

  //   postman[Request]({
  //     name: "PullByCodes - MIX iOS",
  //     id: "a577c017-a6ec-4929-af4f-94bc4a9d8312",
  //     method: "GET",
  //     address: "{{host}}/v1/operational-positions?codes=PopupHomepage",
  //     headers: {
  //       "PG-AppID": "MIX",
  //       "PG-Platform": "iOS",
  //       "PG-AppVersion": "5.2.30"
  //     }
  //   });

  //   postman[Request]({
  //     name: "env",
  //     id: "cf0a1320-7ae4-499c-9e0e-97f4f7022ea3",
  //     method: "GET",
  //     address: "{{host}}/v1/env"
  //   });

  //   postman[Request]({
  //     name: "GET ｜ json配置",
  //     id: "2a47d6fe-9319-489f-8937-31cc95da6772",
  //     method: "GET",
  //     address: "{{host}}/v1/json-config-show?code=123",
  //     headers: {
  //       Host: "mix-api-new.camera360.com"
  //     }
  //   });

  //   postman[Request]({
  //     name: "客户端上报VIP购买信息 Copy",
  //     id: "ce448222-49ab-4512-a627-5b7bdb894a31",
  //     method: "POST",
  //     address: "{{host}}/v1/report-vipinfo",
  //     data:
  //       '{\n    "cid":"test-cid",\n    "receipt":"receipt-test",\n    "expiredAt":1685004123\n}'
  //   });
  // });

  // group("v2", function () {
  //   group("material", function () {
  //     postman[Request]({
  //       name: "素材位 | materials",
  //       id: "4070fabd-f302-4664-ad10-2f6d935f8162",
  //       method: "GET",
  //       address: "{{host}}/v2/material-positions/artisticFilter/materials"
  //     });

  //     postman[Request]({
  //       name: "素材位 | materials Copy",
  //       id: "1837b364-db75-4eb8-a59c-5242a623620f",
  //       method: "GET",
  //       address: "{{host}}/v2/material-positions/androidFont/materials",
  //       headers: {
  //         "Pg-Platform": "Android",
  //         "PG-DataEnv": "dev"
  //       }
  //     });

  //     postman[Request]({
  //       name: "素材位 | categories",
  //       id: "f1e0bbfb-5cd6-442b-9393-f885c5173359",
  //       method: "GET",
  //       address: "{{host}}/v2/material-positions/artisticFilter/categories"
  //     });

  //     postman[Request]({
  //       name: "素材详情 ｜ materialdetail",
  //       id: "b0165cb0-c40a-4088-be7f-10ba078c6ad9",
  //       method: "GET",
  //       address:
  //         "{{host}}/v2/material-positions?pageSize=1&scrollID=&codes=androidFilter&vipStatus=vip"
  //     });

  //     postman[Request]({
  //       name: "素材详情 ｜ materialdetail -mix",
  //       id: "35c0956f-2f36-46fe-b237-1043a1ba2bab",
  //       method: "GET",
  //       address:
  //         "{{host}}/v2/material-positions/material/detail?ids=5923aab543ebf00608f49ec7&withRefs=true&filter=false",
  //       post(response) {
  //         pm.test("Status code is 200", function () {
  //           pm.response.to.have.status(200);
  //         });
  //       }
  //     });

  //     postman[Request]({
  //       name: "素材详情 ｜ materialdetail -mix Copy",
  //       id: "e5d01c82-12a7-44e7-bdda-b8ae01b0ab50",
  //       method: "GET",
  //       address:
  //         "{{host}}/v2/material-positions/material/detail?ids=5923aab543ebf00608f49ec7&withRefs=true&filter=false",
  //       post(response) {
  //         pm.test("Status code is 200", function () {
  //           pm.response.to.have.status(200);
  //         });
  //       }
  //     });
  //   });
  // });

  // group("v4", function () {
  //   postman[Request]({
  //     name: "素材位｜素材列表v4",
  //     id: "6e4073d6-6e65-4a09-ab3b-2fc81c6883fa",
  //     method: "GET",
  //     address:
  //       "{{host}}/v4/material-positions/androidFunctionEnhance/materials",
  //     headers: {
  //       "PG-DataEnv": "qa"
  //     }
  //   });

  //   postman[Request]({
  //     name: "素材详情 ｜ materialdetail",
  //     id: "205c08d0-43b4-47de-8108-5630d208182c",
  //     method: "GET",
  //     address:
  //       "{{host}}/v4/material-positions/material/detail?ids=6569d5b13454af89ce4886ce-&withRefs=true&filter=false",
  //     headers: {
  //       "PG-DataEnv": "dev"
  //     },
  //     post(response) {
  //       pm.test("Status code is 200", function () {
  //         pm.response.to.have.status(200);
  //       });
  //     }
  //   });

  //   postman[Request]({
  //     name: "素材位置 ｜ 分类详情",
  //     id: "75130b29-6264-4737-a33f-a0441d5b58c2",
  //     method: "GET",
  //     address:
  //       "{{host}}/v4/material-positions/categories/detail?ids=64915ea08aaa1038489397fc-64915ea08aaa1038489397fd,64915ed98aaa103848939800-64915ed98aaa103848939801",
  //     headers: {
  //       "PG-DataEnv": "dev"
  //     },
  //     post(response) {
  //       pm.test("Status code is 200", function () {
  //         pm.response.to.have.status(200);
  //       });
  //     }
  //   });

  //   postman[Request]({
  //     name: "素材位 ｜ 分类列表",
  //     id: "976b3c92-05d3-4a07-adda-99d9a5ef4b42",
  //     method: "GET",
  //     address:
  //       "{{host}}/v4/material-positions/reftestWithCate/categories?vipStatus=billing_grace_period"
  //   });

  //   postman[Request]({
  //     name: "运营位 ｜ 物料列表",
  //     id: "4c387756-cdd6-4635-8a26-fea079135b15",
  //     method: "GET",
  //     address:
  //       "{{host}}/v4/operational-positions/ViewfinderIcon/activities?vipStatus=original",
  //     headers: {
  //       "PG-DataEnv": "qa"
  //     }
  //   });

  //   postman[Request]({
  //     name: "运营位 ｜ 物料详情",
  //     id: "6e9d52de-f6d0-47ea-bf2a-3f219eaa0cca",
  //     method: "GET",
  //     address:
  //       "{{host}}/v4/operational-positions/activities/detail?ids=65782ab0bde4de9b7ff6ac28",
  //     headers: {
  //       "PG-DataEnv": "qa"
  //     }
    });
  });

  postman[Pre].pop();
}
